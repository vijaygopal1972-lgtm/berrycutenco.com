<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BerryCuteNCO Admin Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a clean, mobile-friendly dashboard */
        :root {
            --primary: #8B5CF6; /* Purple-500 */
            --secondary: #10B981; /* Emerald-500 */
            --warning: #F59E0B; /* Amber-500 */
            --danger: #EF4444; /* Red-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
        }
        .sidebar {
            width: 100%;
            height: auto;
        }
        .main-content {
            padding: 1rem;
        }
        @media (min-width: 768px) {
            .sidebar {
                width: 250px;
                height: 100vh;
                position: fixed;
            }
            .main-content {
                margin-left: 250px;
            }
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .status-badge {
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#8B5CF6',
                        'secondary': '#10B981',
                        'warning': '#F59E0B',
                        'danger': '#EF4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="md:flex">

    <!-- Sidebar Navigation -->
    <div class="sidebar bg-primary text-white p-6 rounded-r-lg shadow-xl">
        <h1 class="text-2xl font-bold mb-8">Admin Panel</h1>
        <nav>
            <a href="#" class="block p-3 mb-2 rounded-lg bg-white/10 hover:bg-white/20 transition duration-150 font-medium">Dashboard</a>
            <a href="#" class="block p-3 mb-2 rounded-lg hover:bg-white/10 transition duration-150">User Management</a>
            <a href="#" class="block p-3 mb-2 rounded-lg hover:bg-white/10 transition duration-150">Content Metrics</a>
            <a href="#" class="block p-3 mb-2 rounded-lg hover:bg-white/10 transition duration-150">Settings</a>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content flex-1">
        <header class="flex justify-between items-center py-4 border-b border-gray-200 mb-6">
            <h2 class="text-3xl font-extrabold text-gray-900">Welcome, Administrator</h2>
            <div class="flex items-center space-x-4">
                <span id="auth-status" class="text-sm font-medium text-gray-500">Initializing...</span>
                <button id="auth-button" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition duration-150 shadow-md">Login</button>
            </div>
        </header>

        <!-- Admin ID Display (for collaboration) -->
        <div id="admin-id-display" class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg mb-6 hidden" role="alert">
            <p class="font-bold">Admin ID (for collaboration):</p>
            <p id="user-id-text" class="text-sm font-mono break-all"></p>
        </div>

        <!-- Dashboard Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card bg-white p-6 rounded-lg">
                <p class="text-sm font-medium text-gray-500">Total Users</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">15</p>
                <p class="text-xs text-secondary mt-2">Data from Firestore</p>
            </div>
            <div class="card bg-white p-6 rounded-lg">
                <p class="text-sm font-medium text-gray-500">Total Items</p>
                <p id="total-inventory-count" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                <p class="text-xs text-secondary mt-2">Inventory Count</p>
            </div>
            <div class="card bg-white p-6 rounded-lg">
                <p class="text-sm font-medium text-gray-500">Low Stock Items</p>
                <p id="low-stock-count" class="text-3xl font-bold text-danger mt-1">0</p>
                <p class="text-xs text-danger mt-2">Needs Reorder</p>
            </div>
            <div class="card bg-white p-6 rounded-lg">
                <p class="text-sm font-medium text-gray-500">Server Load</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">15%</p>
                <p class="text-xs text-secondary mt-2">Data from Free tier</p>
            </div>
        </div>
        
        <!-- Inventory Section (NEW) -->
        <div class="bg-white p-6 rounded-lg card mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Inventory Management</h3>
                <button class="bg-secondary text-white px-4 py-2 rounded-lg font-semibold hover:bg-secondary/90 transition duration-150 shadow-md">
                    + Add New Item
                </button>
            </div>
            
            <!-- Inventory Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name / SKU</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-list" class="bg-white divide-y divide-gray-200">
                        <!-- Inventory rows will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Inventory Loading Indicator -->
            <div id="inventory-loading-indicator" class="text-center py-4 text-gray-500">
                Loading inventory...
            </div>
        </div>

        <!-- Orders Section (Existing) -->
        <div class="bg-white p-6 rounded-lg card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Current Orders</h3>
                <select id="status-filter" class="p-2 border border-gray-300 rounded-lg">
                    <option value="ALL">All Statuses</option>
                    <option value="Processing">Processing</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Pending">Pending</option>
                </select>
            </div>

            <!-- Orders Loading Indicator -->
            <div id="orders-loading-indicator" class="text-center py-4 text-gray-500">
                Waiting for initialization...
            </div>

            <!-- Orders List -->
            <ul id="orders-list" class="space-y-4">
                <!-- Orders will be populated here by JavaScript -->
            </ul>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level for debugging (optional)
        setLogLevel('debug');

        // --- GLOBAL VARIABLES (Accessible outside functions) ---
        let db; // Global Firestore instance
        let auth; // Global Auth instance
        let userID = null;
        let isAuthReady = false;
        let allOrders = [];
        let allInventory = []; // NEW: Array to hold all inventory items
        let currentStatusFilter = 'ALL';

        // --- DOM Elements ---
        const authStatusEl = document.getElementById('auth-status');
        const ordersListEl = document.getElementById('orders-list');
        const ordersLoadingIndicator = document.getElementById('orders-loading-indicator');
        const inventoryListEl = document.getElementById('inventory-list'); // NEW
        const inventoryLoadingIndicator = document.getElementById('inventory-loading-indicator'); // NEW
        const statusFilterEl = document.getElementById('status-filter');
        const adminIdDisplay = document.getElementById('admin-id-display');
        const userIdTextEl = document.getElementById('user-id-text');
        const totalInventoryCountEl = document.getElementById('total-inventory-count'); // NEW
        const lowStockCountEl = document.getElementById('low-stock-count'); // NEW

        // --- CORE FUNCTIONS ---

        /**
         * 1. Firebase Initialization and Authentication
         */
        async function initializeFirebase() {
            // Get environment variables safely inside the function
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // Correctly parse the config from the environment
            let firebaseConfig;
            try {
                // Use a fallback of '{}' (empty object) if __firebase_config is undefined
                const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                firebaseConfig = JSON.parse(configString);
            } catch (e) {
                console.error("FATAL ERROR: Failed to parse Firebase config string.", e);
                authStatusEl.textContent = 'CONFIG PARSE ERROR';
                return; // Stop initialization
            }

            if (!firebaseConfig.projectId) {
                console.error("FATAL ERROR: Firebase configuration missing Project ID.");
                authStatusEl.textContent = 'FATAL ERROR (Missing Config)';
                adminIdDisplay.classList.remove('bg-blue-100');
                adminIdDisplay.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                userIdTextEl.textContent = 'Configuration Error: Missing Project ID';
                adminIdDisplay.classList.remove('hidden');
                return; // Stop initialization
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                authStatusEl.textContent = 'Authenticating...';

                // Sign in using the provided token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userID = user.uid;
                        authStatusEl.textContent = `User: ${userID.substring(0, 8)}...`;
                        userIdTextEl.textContent = userID; // Full ID for collaboration
                        adminIdDisplay.classList.remove('hidden');
                        isAuthReady = true;
                        
                        // Start real-time listeners only AFTER auth is ready
                        setupRealtimeFirestoreListeners(appId, db, auth);
                    } else {
                        userID = null;
                        authStatusEl.textContent = 'Signed Out';
                        isAuthReady = true;
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatusEl.textContent = 'INIT ERROR';
            }
        }

        /**
         * 2. Setup ALL Real-time Firestore Listeners
         */
        function setupRealtimeFirestoreListeners(appId, db, auth) {
            if (!db || !auth.currentUser) return;

            // 2A. ORDERS Listener
            const ordersCollectionPath = `artifacts/${appId}/public/data/orders`;
            const ordersRef = collection(db, ordersCollectionPath);
            ordersLoadingIndicator.classList.remove('hidden');

            onSnapshot(query(ordersRef), (querySnapshot) => {
                ordersLoadingIndicator.classList.add('hidden');
                let fetchedOrders = [];

                querySnapshot.forEach((doc) => {
                    fetchedOrders.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                allOrders = fetchedOrders;

                // Sort in JavaScript: Newest orders first (by createdAt)
                allOrders.sort((a, b) => {
                    const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                    return timeB - timeA;
                });
                
                renderFilteredOrders();

            }, (error) => {
                console.error("Firestore error on orders snapshot:", error);
                ordersLoadingIndicator.classList.add('hidden');
                ordersListEl.innerHTML = `<p class="text-red-500 text-center">Error fetching orders: ${error.message}</p>`;
            });

            // 2B. INVENTORY Listener (NEW)
            const inventoryCollectionPath = `artifacts/${appId}/public/data/inventory`;
            const inventoryRef = collection(db, inventoryCollectionPath);
            inventoryLoadingIndicator.classList.remove('hidden');

            onSnapshot(query(inventoryRef), (querySnapshot) => {
                inventoryLoadingIndicator.classList.add('hidden');
                let fetchedInventory = [];
                let lowStockCount = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = {
                        id: doc.id,
                        ...data,
                        quantityInStock: data.quantityInStock || 0,
                        lowStockThreshold: data.lowStockThreshold || 10 // Default threshold
                    };

                    if (item.quantityInStock <= item.lowStockThreshold) {
                        lowStockCount++;
                    }

                    fetchedInventory.push(item);
                });

                allInventory = fetchedInventory;
                totalInventoryCountEl.textContent = allInventory.length;
                lowStockCountEl.textContent = lowStockCount;

                // Sort inventory by quantity in stock (lowest first)
                allInventory.sort((a, b) => a.quantityInStock - b.quantityInStock);
                
                renderInventory();

            }, (error) => {
                console.error("Firestore error on inventory snapshot:", error);
                inventoryLoadingIndicator.classList.add('hidden');
                inventoryListEl.innerHTML = `<tr><td colspan="4" class="py-4 text-red-500 text-center">Error fetching inventory: ${error.message}</td></tr>`;
            });
        }

        /**
         * 3. Utility function to render orders based on the current filter.
         */
        function renderFilteredOrders() {
            ordersListEl.innerHTML = '';
            
            const filteredOrders = allOrders.filter(order => 
                currentStatusFilter === 'ALL' || order.status === currentStatusFilter
            );

            if (filteredOrders.length === 0) {
                ordersListEl.innerHTML = `<p class="text-gray-500 text-center py-4">No orders found with status: ${currentStatusFilter}</p>`;
                return;
            }

            filteredOrders.forEach(order => {
                const date = order.createdAt ? order.createdAt.toDate().toLocaleDateString() : 'N/A';
                const time = order.createdAt ? order.createdAt.toDate().toLocaleTimeString() : 'N/A';
                const statusBadge = getStatusBadge(order.status);

                const li = document.createElement('li');
                li.className = 'flex flex-col md:flex-row justify-between items-start md:items-center bg-gray-50 p-4 rounded-lg border border-gray-200';
                li.innerHTML = `
                    <div class="mb-2 md:mb-0">
                        <p class="font-semibold text-gray-800 break-all">Order ID: ${order.id}</p>
                        <p class="text-sm text-gray-500">Created: ${date} at ${time}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        ${statusBadge}
                        <button class="bg-primary text-white px-3 py-1 text-sm rounded-lg hover:bg-primary/90 transition duration-150 shadow-sm handle-update-btn"
                                data-id="${order.id}" data-status="${order.status}">
                            Update Status
                        </button>
                    </div>
                `;
                ordersListEl.appendChild(li);
            });
            
            // Attach click listeners to new buttons
            document.querySelectorAll('.handle-update-btn').forEach(button => {
                button.addEventListener('click', (event) => handleStatusUpdate(event, db, auth));
            });
        }

        /**
         * 4. Utility function for dynamic status badges (Orders)
         */
        function getStatusBadge(status) {
            let style;
            switch (status) {
                case 'Pending':
                    style = 'bg-red-200 text-red-800';
                    break;
                case 'Processing':
                    style = 'bg-yellow-200 text-yellow-800';
                    break;
                case 'Delivered':
                    style = 'bg-green-200 text-green-800';
                    break;
                default:
                    style = 'bg-gray-200 text-gray-800';
                    break;
            }
            return `<span class="status-badge ${style}">${status}</span>`;
        }

        /**
         * 5. Handle Status Update (Orders)
         */
        async function handleStatusUpdate(event, db, auth) {
            const orderId = event.currentTarget.getAttribute('data-id');
            const currentStatus = event.currentTarget.getAttribute('data-status');

            if (!db || !orderId || !auth.currentUser) return;
            
            // Define next status (simple cycle)
            let newStatus;
            switch (currentStatus) {
                case 'Pending':
                    newStatus = 'Processing';
                    break;
                case 'Processing':
                    newStatus = 'Delivered';
                    break;
                default:
                    newStatus = 'Pending';
                    break;
            }

            event.currentTarget.classList.add('opacity-50');
            event.currentTarget.disabled = true;

            const ordersCollectionPath = `artifacts/${auth.currentUser.uid}/public/data/orders`;
            const orderDocRef = doc(db, ordersCollectionPath, orderId);
            
            try {
                await updateDoc(orderDocRef, {
                    status: newStatus,
                    updatedAt: serverTimestamp()
                });
                // Success is handled by the real-time snapshot listener (onSnapshot)
            } catch (err) {
                console.error("Update error:", err);
                authStatusEl.textContent = `UPDATE FAILED for ${orderId}`; 
                event.currentTarget.classList.remove('opacity-50');
                event.currentTarget.disabled = false;
            }
        }

        /**
         * 6. Render Inventory List (NEW)
         */
        function renderInventory() {
            inventoryListEl.innerHTML = ''; // Clear previous rows

            if (allInventory.length === 0) {
                inventoryListEl.innerHTML = `<tr><td colspan="4" class="py-4 text-gray-500 text-center">No inventory items found. Add some in the Firebase Console!</td></tr>`;
                return;
            }

            allInventory.forEach(item => {
                const isLowStock = item.quantityInStock <= item.lowStockThreshold;
                
                let stockText = `${item.quantityInStock}`;
                let stockClass = 'text-gray-800';

                if (isLowStock) {
                    stockText = `ðŸš¨ ${item.quantityInStock} (LOW)`;
                    stockClass = 'font-bold text-danger';
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition duration-100';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${item.itemName || 'N/A'}</div>
                        <div class="text-xs text-gray-500 break-all">${item.skuOrProductID || item.id}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm ${stockClass}">${stockText}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-800">$${(item.sellingPrice || 0).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-primary hover:text-primary/80 transition duration-150 edit-inventory-btn"
                                data-id="${item.id}">
                            Edit Stock
                        </button>
                    </td>
                `;
                inventoryListEl.appendChild(row);
            });
            
            // Note: Edit Stock buttons are placeholders for now, the functionality isn't implemented.
        }


        // --- EVENT LISTENERS ---

        // Listen for filter changes and re-render the orders list
        statusFilterEl.addEventListener('change', (event) => {
            currentStatusFilter = event.target.value;
            renderFilteredOrders();
        });
        
        // --- START THE APPLICATION ---
        window.onload = initializeFirebase; 

    </script>
</body>
</html>
