<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BerryCuteNCO Admin Panel</title>
    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for Admin Dashboard */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .sidebar {
            width: 280px;
            background-color: #1a202c; /* Dark background for sidebar */
        }
        .main-content {
            min-height: 100vh;
        }
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .nav-link {
            transition: all 0.2s;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
        }
        .nav-link:hover {
            background-color: #2d3748; /* Darker on hover */
        }
        .nav-link.active {
            background-color: #4c51bf; /* Blue for active link */
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body class="flex">

    <!-- Sidebar -->
    <div class="sidebar text-gray-300 flex flex-col h-screen fixed">
        <div class="p-6 text-xl font-bold text-white border-b border-gray-700">
            Admin Panel
        </div>
        <nav class="flex-grow">
            <a class="nav-link flex items-center space-x-3 active" href="#">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                <span>Dashboard</span>
            </a>
            <a class="nav-link flex items-center space-x-3" href="#">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-3m-1.2-5.8l-5.3-5.3c-1.3-1.3-3.4-1.3-4.7 0l-5.3 5.3c-1.3 1.3-1.3 3.4 0 4.7l5.3 5.3c1.3 1.3 3.4 1.3 4.7 0l5.3-5.3c1.3-1.3 1.3-3.4 0-4.7z"></path></svg>
                <span>User Management</span>
            </a>
            <a class="nav-link flex items-center space-x-3" href="#">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6m-4-6h4"></path></svg>
                <span>Content Metrics</span>
            </a>
            <a class="nav-link flex items-center space-x-3" href="#">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>Settings</span>
            </a>
        </nav>
        <div class="p-4 border-t border-gray-700">
            <button id="auth-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors">
                Login
            </button>
            <p id="auth-status" class="text-xs mt-2 text-center text-red-400">Loading...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content flex-1 ml-72 p-8">
        <header class="flex justify-between items-center pb-6 border-b mb-6">
            <h1 class="text-3xl font-extrabold text-gray-800">Welcome, Administrator</h1>
            <div class="flex items-center space-x-4">
                <span id="admin-id-display" class="text-sm font-medium text-gray-500">User ID: Loading...</span>
                <button id="logout-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg shadow-sm transition-colors hidden">Logout</button>
            </div>
        </header>

        <!-- Dashboard Overview -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-5">
                <p class="text-sm font-semibold text-gray-500">Total Users</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">Loading...</p>
                <p class="text-xs text-gray-400">Data from Firestore</p>
            </div>
            <div class="card p-5">
                <p class="text-sm font-semibold text-gray-500">New Comments</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">Loading...</p>
                <p class="text-xs text-gray-400">Data from Firestore</p>
            </div>
            <div class="card p-5">
                <p class="text-sm font-semibold text-gray-500">Pending Approvals</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">Loading...</p>
                <p class="text-xs text-gray-400">Data from Firestore</p>
            </div>
            <div class="card p-5">
                <p class="text-sm font-semibold text-gray-500">Server Load</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">Loading...%</p>
                <p class="text-xs text-gray-400">Data from FreeDOM</p>
            </div>
        </section>

        <!-- Orders Section -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Current Orders</h2>
            <div class="card p-6">
                <!-- Filter Section -->
                <div class="flex justify-between items-center mb-4">
                    <div id="status-filter" class="flex space-x-2 text-sm">
                        <button data-status="ALL" class="filter-btn bg-indigo-500 text-white px-3 py-1 rounded-full shadow-md transition-colors hover:bg-indigo-600">All</button>
                        <button data-status="Processing" class="filter-btn bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full hover:bg-yellow-300">Processing</button>
                        <button data-status="Delivered" class="filter-btn bg-green-200 text-green-800 px-3 py-1 rounded-full hover:bg-green-300">Delivered</button>
                        <button data-status="Cancelled" class="filter-btn bg-red-200 text-red-800 px-3 py-1 rounded-full hover:bg-red-300">Cancelled</button>
                    </div>
                    <div id="loading-indicator" class="flex items-center space-x-2 text-sm text-indigo-600 hidden">
                        <svg class="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Loading Orders...</span>
                    </div>
                </div>

                <!-- Orders List -->
                <div id="orders-list" class="space-y-4">
                    <p class="text-center text-gray-500 p-4">Waiting for initialization.</p>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Custom Modal for Alerts/Confirmation (instead of alert/confirm) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800">Notification</h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors hidden">Cancel</button>
                <button id="modal-confirm-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">OK</button>
            </div>
        </div>
    </div>
    

    <script type="module">
        // Import Firebase components
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, limit, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level for debugging (optional)
        setLogLevel('debug');

        // --- GLOBAL VARIABLES (Accessible outside functions) ---
        let db; // Global Firestore instance
        let auth; // Global Auth instance
        let userId = null;
        let isAuthReady = false; 
        let allOrders = [];
        let currentStatusFilter = 'ALL';

        // --- DOM Elements ---
        const authStatusEl = document.getElementById('auth-status');
        const ordersListEl = document.getElementById('orders-list');
        const loadingIndicatorEl = document.getElementById('loading-indicator');
        const statusFilterEl = document.getElementById('status-filter');
        const adminIdDisplayEl = document.getElementById('admin-id-display');
        const authButtonEl = document.getElementById('auth-button');
        const logoutButtonEl = document.getElementById('logout-button');
        
        // Modal Elements
        const customModalEl = document.getElementById('custom-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalMessageEl = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');


        // --- UTILITY FUNCTIONS ---

        /**
         * Custom display function instead of alert() or confirm().
         * @param {string} title - Title for the modal.
         * @param {string} message - Message content.
         * @param {boolean} isConfirm - If true, show a Cancel button and return a Promise.
         * @returns {Promise<boolean>|void} Resolves true/false if isConfirm is true.
         */
        function showCustomModal(title, message, isConfirm = false) {
            modalTitleEl.textContent = title;
            modalMessageEl.textContent = message;
            customModalEl.classList.remove('hidden');

            if (isConfirm) {
                modalCancelBtn.classList.remove('hidden');
                return new Promise(resolve => {
                    modalConfirmBtn.onclick = () => {
                        customModalEl.classList.add('hidden');
                        modalCancelBtn.classList.add('hidden');
                        resolve(true);
                    };
                    modalCancelBtn.onclick = () => {
                        customModalEl.classList.add('hidden');
                        modalCancelBtn.classList.add('hidden');
                        resolve(false);
                    };
                });
            } else {
                modalCancelBtn.classList.add('hidden');
                modalConfirmBtn.onclick = () => {
                    customModalEl.classList.add('hidden');
                };
            }
        }


        // --- CORE FUNCTIONS ---

        // 1. Firebase Initialization and Authentication
        async function initializeFirebase() {
            // Get environment variables safely inside the function
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // Correctly parse the config from the environment
            const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            let firebaseConfig;

            try {
                firebaseConfig = JSON.parse(configString);
            } catch (e) {
                console.error('FATAL ERROR: Failed to parse Firebase config string.', e);
                authStatusEl.textContent = 'CONFIG PARSE ERROR';
                return; // Stop initialization
            }

            // Check for critical project ID
            if (!firebaseConfig.projectId) {
                console.error('FATAL ERROR: Firebase configuration missing Project ID.');
                authStatusEl.textContent = 'FATAL ERROR (Missing Config)';
                return; // Stop initialization
            }

            try {
                const app = initializeApp(firebaseConfig);
                
                // ASSIGNMENT (No const/let/var here, using the global 'let db;' from above)
                db = getFirestore(app);
                auth = getAuth(app);

                authStatusEl.textContent = 'Authenticating...';

                // We must await for the onAuthStateChanged to resolve before proceeding
                // This ensures we have the correct userId before trying to fetch data
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            adminIdDisplayEl.textContent = `User ID: ${userId}`;
                            authButtonEl.textContent = 'Logout';
                            authButtonEl.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                            authButtonEl.classList.add('bg-red-600', 'hover:bg-red-700');
                            
                            // Once authenticated, start the real-time data listener
                            setupRealtimeFirestoreListener(appId, db, auth);
                        } else {
                            // User is signed out or anonymous
                            userId = null;
                            adminIdDisplayEl.textContent = 'User ID: N/A';
                            authButtonEl.textContent = 'Login';
                            authButtonEl.classList.remove('bg-red-600', 'hover:bg-red-700');
                            authButtonEl.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                            ordersListEl.innerHTML = '<p class="text-center text-gray-500 p-4">Please log in to view orders.</p>';
                        }
                        authStatusEl.textContent = user ? 'Authenticated' : 'Logged Out';
                        isAuthReady = true; // Mark auth process as complete
                        unsubscribe(); // Stop listening after the first check
                        resolve();
                    });
                });

                // Sign in using the provided token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in if token is missing
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error('Failed to initialize Firebase:', error.message, error);
                authStatusEl.textContent = `ERROR: ${error.code}`;
            }
        }


        // 2. Setup Real-time Firestore Listener for Orders
        function setupRealtimeFirestoreListener(appId, db, auth) {
            if (!db || !isAuthReady) return; // Wait until Firebase is fully initialized and authenticated

            loadingIndicatorEl.classList.remove('hidden');

            // Use the public path for collaborative data
            const ordersCollectionPath = `artifacts/${appId}/public/data/orders`;
            const ordersRef = collection(db, ordersCollectionPath);

            // Fetch the entire collection (filtering is done in memory for simplicity)
            const q = query(ordersRef);

            // Set up real-time listener
            onSnapshot(q, (querySnapshot) => {
                loadingIndicatorEl.classList.add('hidden'); // Hide loading indicator on successful fetch

                let fetchedOrders = [];
                querySnapshot.forEach((doc) => {
                    // console.log("Fetched order doc:", doc.id, doc.data());
                    fetchedOrders.push({ id: doc.id, ...doc.data() });
                });

                // Store all orders globally
                allOrders = fetchedOrders;

                // Sort orders in JavaScript: Newest first (by createdAt)
                // We access the timestamp object and convert to milliseconds for sorting
                allOrders.sort((a, b) => {
                    const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                    return timeB - timeA; // Descending order (newest first)
                });

                renderFilteredOrders();

            }, (error) => {
                console.error("Error updating status for orders on onSnapshot:", error);
                loadingIndicatorEl.classList.add('hidden');
                ordersListEl.innerHTML = `<p class="text-center text-red-500 p-4">Error fetching orders: ${error.message}</p>`;
            });
        }


        // 3. Rendering Functions

        /**
         * Renders the order list based on the currentStatusFilter.
         */
        function renderFilteredOrders() {
            ordersListEl.innerHTML = ''; // Clear existing orders

            const filteredOrders = allOrders.filter(order => 
                currentStatusFilter === 'ALL' || order.status === currentStatusFilter
            );

            if (filteredOrders.length === 0) {
                ordersListEl.innerHTML = `<p class="text-center text-gray-500 p-4">No ${currentStatusFilter.toLowerCase()} orders found.</p>`;
                return;
            }

            filteredOrders.forEach(order => {
                ordersListEl.appendChild(createOrderCard(order));
            });

            // Set the active filter button style
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.getAttribute('data-status') === currentStatusFilter) {
                    btn.classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
                } else {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
                }
            });
        }

        /**
         * Creates an HTML element for a single order.
         * @param {object} order - The order data.
         * @returns {HTMLElement} The created order card element.
         */
        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'flex justify-between items-center p-4 border rounded-lg shadow-sm bg-white hover:shadow-md transition-shadow';
            card.setAttribute('data-order-id', order.id);

            const date = order.createdAt ? order.createdAt.toDate().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'N/A';

            // Order details
            const details = `
                <div>
                    <p class="text-sm font-semibold text-gray-800">${order.id}</p>
                    <p class="text-xs text-gray-500">Placed: ${date}</p>
                    <p class="text-xs text-gray-500">Status: <span class="${getStatusStyles(order.status)} px-2 py-0.5 rounded-full text-xs font-medium">${order.status}</span></p>
                </div>
            `;

            // Status update controls
            const controls = document.createElement('div');
            controls.className = 'flex space-x-2';
            
            const nextStatus = getNextStatus(order.status);
            if (nextStatus) {
                const updateButton = document.createElement('button');
                updateButton.textContent = `Mark as ${nextStatus}`;
                updateButton.className = 'update-btn bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors';
                updateButton.setAttribute('data-order-id', order.id);
                updateButton.setAttribute('data-status', order.status);
                updateButton.setAttribute('data-next-status', nextStatus);
                updateButton.onclick = handleStatusUpdate;
                controls.appendChild(updateButton);
            }

            // Cancel button
            if (order.status !== 'Cancelled') {
                 const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.className = 'cancel-btn bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors';
                cancelButton.setAttribute('data-order-id', order.id);
                cancelButton.setAttribute('data-status', order.status);
                cancelButton.setAttribute('data-next-status', 'Cancelled');
                cancelButton.onclick = handleStatusUpdate;
                controls.appendChild(cancelButton);
            }
           

            card.innerHTML = details;
            card.appendChild(controls);

            return card;
        }

        /**
         * Determines the next logical status for an order.
         * @param {string} currentStatus - The current status of the order.
         * @returns {string|null} The next status, or null if it's a terminal status.
         */
        function getNextStatus(currentStatus) {
            switch (currentStatus) {
                case 'Processing':
                    return 'Shipped';
                case 'Shipped':
                    return 'Delivered';
                case 'Delivered':
                case 'Cancelled':
                default:
                    return null;
            }
        }
        
        /**
         * Returns Tailwind CSS classes for status display.
         * @param {string} status - The status string.
         * @returns {string} Tailwind CSS classes.
         */
        function getStatusStyles(status) {
            switch (status) {
                case 'Processing':
                    return 'bg-yellow-200 text-yellow-800';
                case 'Shipped':
                    return 'bg-blue-200 text-blue-800';
                case 'Delivered':
                    return 'bg-green-200 text-green-800';
                case 'Cancelled':
                    return 'bg-red-200 text-red-800';
                default:
                    return 'bg-gray-200 text-gray-800';
            }
        }


        // 4. Handle Status Update
        async function handleStatusUpdate(event) {
            if (!db) {
                showCustomModal('Error', 'Database not initialized. Please refresh and try again.', false);
                return;
            }
            
            const orderId = event.currentTarget.getAttribute('data-order-id');
            const currentStatus = event.currentTarget.getAttribute('data-status');
            const newStatus = event.currentTarget.getAttribute('data-next-status');

            if (!orderId || !newStatus) return;

            // Confirmation check before cancelling
            if (newStatus === 'Cancelled') {
                const isConfirmed = await showCustomModal(
                    'Confirm Cancellation', 
                    `Are you sure you want to cancel order ID: ${orderId}? This cannot be undone.`, 
                    true
                );
                if (!isConfirmed) return;
            }

            // Visually disable the button and show a loading state on the button itself
            event.currentTarget.classList.add('opacity-50');
            event.currentTarget.disabled = true;

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const docPath = `artifacts/${appId}/public/data/orders/${orderId}`;
                const orderDocRef = doc(db, docPath);

                await updateDoc(orderDocRef, {
                    status: newStatus,
                    updatedAt: serverTimestamp()
                });

                // Success message
                showCustomModal('Success', `Order ${orderId} status updated to: ${newStatus}`, false);

            } catch (error) {
                console.error(`Error updating status for ${orderId}:`, error);
                showCustomModal('Update Failed', `Could not update status for order ${orderId}. Error: ${error.message}`, false);
            } finally {
                // Re-enable the button regardless of success/fail
                event.currentTarget.classList.remove('opacity-50');
                event.currentTarget.disabled = false;
            }
        }

        // 5. Event Listeners for Filters and Auth

        function setupEventListeners() {
            // Filter buttons
            statusFilterEl.addEventListener('click', (event) => {
                if (event.target.classList.contains('filter-btn')) {
                    const status = event.target.getAttribute('data-status');
                    if (status) {
                        currentStatusFilter = status;
                        renderFilteredOrders();
                    }
                }
            });

            // Auth button (Login/Logout)
            authButtonEl.addEventListener('click', async () => {
                if (!auth || !isAuthReady) return;

                if (auth.currentUser) {
                    try {
                        await signOut(auth);
                        showCustomModal('Logout', 'You have been successfully logged out.', false);
                    } catch (error) {
                        console.error('Logout error:', error);
                        showCustomModal('Logout Failed', `Could not log out. Error: ${error.message}`, false);
                    }
                } else {
                    // Re-run initialization to attempt sign-in
                    await initializeFirebase();
                }
            });
        }


        // --- ENTRY POINT ---
        window.onload = function () {
            setupEventListeners();
            initializeFirebase();
        }

    </script>
</body>
</html>
