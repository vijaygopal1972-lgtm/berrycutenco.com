<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Initialization Debugger</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-blue-100">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944c-1.258 0-2.515.115-3.744.349-1.228.234-2.433.585-3.578 1.057a11.936 11.936 0 00-3.578 3.578c-.472 1.145-.823 2.349-1.057 3.578-.234 1.228-.349 2.485-.349 3.744s.115 2.515.349 3.744c.234 1.228.585 2.433 1.057 3.578a11.936 11.936 0 003.578 3.578c1.145.472 2.349.823 3.578 1.057s2.485.349 3.744.349 2.515-.115 3.744-.349c1.228-.234 2.433-.585 3.578-1.057a11.936 11.936 0 003.578-3.578c.472-1.145.823-2.349 1.057-3.578s.349-2.485.349-3.744-.115-2.515-.349-3.744c-.234-1.228-.585-2.433-1.057-3.578a11.936 11.936 0 00-3.578-3.578z"></path></svg>
            Initialization Status
        </h1>

        <div id="status-display" class="p-4 bg-gray-100 border border-gray-300 rounded-lg text-sm text-gray-600 space-y-2">
            <p id="config-status" class="font-medium text-gray-700">Config: <span class="text-yellow-600">Loading...</span></p>
            <p id="init-status" class="font-medium text-gray-700">App Init: <span class="text-yellow-600">Pending...</span></p>
            <p id="auth-status" class="font-medium text-gray-700">Auth: <span class="text-yellow-600">Pending...</span></p>
        </div>

        <div id="result-card" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
            <p class="font-semibold text-blue-700">Success!</p>
            <p id="user-id" class="break-all mt-1 text-sm text-blue-900"></p>
            <p class="mt-3 text-xs text-blue-600">The core services are now running correctly.</p>
        </div>

        <div id="error-card" class="mt-6 p-4 bg-red-100 border border-red-300 rounded-lg hidden">
            <p class="font-semibold text-red-700">Fatal Error:</p>
            <p id="error-message" class="break-all mt-1 text-sm text-red-900"></p>
        </div>

        <p class="mt-6 text-xs text-gray-500">This file has been modified to support **manual insertion** of the Firebase configuration object.</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserSessionPersistence, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to Debug to see all Firebase operations in the console
        setLogLevel('Debug');
        
        // --- DOM Elements for Status Updates ---
        const configStatusEl = document.getElementById('config-status').querySelector('span');
        const initStatusEl = document.getElementById('init-status').querySelector('span');
        const authStatusEl = document.getElementById('auth-status').querySelector('span');
        const errorCard = document.getElementById('error-card');
        const errorMessageEl = document.getElementById('error-message');
        const resultCard = document.getElementById('result-card');
        const userIdEl = document.getElementById('user-id');
        
        function updateStatus(element, text, colorClass) {
            element.textContent = text;
            element.className = colorClass;
        }

        /**
         * Safely initializes Firebase and performs authentication.
         */
        async function initializeFirebase() {
            let firebaseConfig;
            
            // --- 1. MANUAL FIREBASE CONFIGURATION START ---
            // !!! REPLACE ALL "YOUR_..." PLACEHOLDERS WITH YOUR ACTUAL VALUES FROM FIREBASE !!!
           
                // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyA34RRGtvkPiqGMAKYlnylHE6UGGx3Dqic",
  authDomain: "berrycutenco-24946.firebaseapp.com",
  projectId: "berrycutenco-24946",
  storageBucket: "berrycutenco-24946.firebasestorage.app",
  messagingSenderId: "547763232832",
  appId: "1:547763232832:web:4ed243584ad9194976ffa5",
  measurementId: "G-71RM0SRJEH"
};

            // Check if placeholders were replaced
            if (firebaseConfig.apiKey.includes('YOUR_')) {
                updateStatus(configStatusEl, 'PLACEHOLDER', 'text-red-600');
                handleFatalError("Config Error: Please replace all 'YOUR_...' placeholders in firebaseConfig.");
                return;
            }
            updateStatus(configStatusEl, 'OK (Manual)', 'text-green-600');
            // --- 1. MANUAL FIREBASE CONFIGURATION END ---


            // 2. Initialize Firebase App
            let app, auth, db;
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                updateStatus(initStatusEl, 'OK', 'text-green-600');
            } catch (e) {
                updateStatus(initStatusEl, 'FAILED', 'text-red-600');
                handleFatalError("App Init Error: " + e.message);
                return;
            }

            // 3. Handle Authentication (Still checks for the environment token for testing)
            try {
                // Ensure persistence is set to session for security in this environment
                await setPersistence(auth, browserSessionPersistence);
                
                let authResult;
                // This will be null if running outside the platform, forcing Anonymous sign-in
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    console.log("Attempting sign-in with custom token...");
                    authResult = await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Custom token not found. Signing in anonymously...");
                    authResult = await signInAnonymously(auth);
                }

                if (authResult.user) {
                    const userId = authResult.user.uid;
                    updateStatus(authStatusEl, 'Success', 'text-green-600');
                    showSuccess(userId);
                    console.log("Successfully authenticated user:", userId);
                    
                    // You can now proceed with Firestore operations using 'db' and 'userId'
                } else {
                    throw new Error("Authentication failed: No user object returned.");
                }

            } catch (e) {
                // This catch specifically handles the 'auth/configuration-not-found' 
                // and other auth-related errors.
                updateStatus(authStatusEl, 'FAILED', 'text-red-600');
                handleFatalError(`Authentication Failed: ${e.code || 'UNKNOWN'} - ${e.message}`);
            }
        }
        
        /**
         * Displays the fatal error message on the UI.
         * @param {string} message 
         */
        function handleFatalError(message) {
            console.error("FIREBASE INITIALIZATION FAILED:", message);
            errorCard.classList.remove('hidden');
            errorMessageEl.textContent = message;
            // Hide the success card if an error occurs
            resultCard.classList.add('hidden');
        }

        /**
         * Displays the successful initialization status and User ID.
         * @param {string} userId 
         */
        function showSuccess(userId) {
            resultCard.classList.remove('hidden');
            userIdEl.textContent = "User ID: " + userId;
            // Hide the error card if successful
            errorCard.classList.add('hidden');
        }

        window.onload = initializeFirebase;
    </script>
</body>
</html>
