 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BerryCuteNCo - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4ff; /* Light Blue/Purple Background */ }
        .container-wrapper {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }
        .section-card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        /* Custom "Cute" Button Styling */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="container-wrapper">
        <header class="text-center py-8">
            <h1 class="text-4xl font-extrabold text-[#8a2be2]">üì¶ BerryCuteNCo Admin Dashboard</h1>
            <p id="auth-status" class="text-sm text-gray-500 mt-2">Connecting to secure system...</p>
        </header>

        <!-- Admin Dashboard Section -->
        <div id="admin-dashboard-wrapper" class="section-card">

            <!-- Admin Key Input (Default View) -->
            <div id="admin-key-input" class="mb-6 p-4 bg-purple-100 rounded-xl text-center">
                <h3 class="font-bold text-2xl text-purple-700 mb-3">üîí Admin Access Required</h3>
                <p class="text-sm text-purple-600 mb-4">Enter the secret key to view and manage orders.</p>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 max-w-sm mx-auto">
                    <input type="password" id="admin-secret-key" placeholder="Admin Secret Key" 
                           class="flex-grow p-3 border border-purple-400 rounded-lg">
                    <!-- The onclick handler needs directHandleUnlock to be global -->
                    <button id="unlock-btn" onclick="directHandleUnlock()" 
                            class="text-lg px-6 py-2 bg-[#8a2be2] text-white rounded-lg hover:bg-purple-600 transition-colors font-bold">
                        Unlock
                    </button>
                </div>
                <p id="key-message" class="text-sm mt-3 font-semibold"></p>
            </div>

            <!-- Actual Dashboard Content (Hidden until unlocked) -->
            <div id="admin-dashboard-content" class="hidden">
                <p class="text-sm text-gray-500 mb-4">Managing orders in real-time. Admin ID: <span id="admin-id-display" class="font-mono text-xs text-purple-600"></span></p>
                
                <!-- FILTER DROPDOWN -->
                <div class="mb-4">
                    <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Status:</label>
                    <select id="status-filter" class="p-2 border border-purple-300 rounded-lg bg-white focus:ring-2 focus:ring-[#8a2be2]">
                        <option value="All">All Orders</option>
                        <option value="New">New</option>
                        <option value="Processing">Processing</option>
                        <option value="Delivered">Delivered</option>
                    </select>
                </div>

                <div id="orders-list" class="space-y-4">
                    <!-- Orders will be loaded here in real-time -->
                    <div id="loading-indicator" class="text-center p-4 text-[#ff69b4]">
                        <svg class="animate-spin h-5 w-5 mr-3 inline text-[#ff69b4]" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Awaiting Orders...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');
        
        // --- GLOBAL CONSTANTS ---
        const ADMIN_SECRET = 'berrycute123'; // <<< YOUR TEAM'S SECRET KEY HERE

        // --- GLOBAL VARIABLES (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let allOrders = []; 
        let currentStatusFilter = 'All'; 

        // --- DOM Elements ---
        const authStatusEl = document.getElementById('auth-status');
        const ordersListEl = document.getElementById('orders-list');
        const loadingIndicator = document.getElementById('loading-indicator');
        const statusFilterEl = document.getElementById('status-filter'); 
        const adminDashboardContent = document.getElementById('admin-dashboard-content'); 
        const adminIdDisplay = document.getElementById('admin-id-display');
        
        // Admin Key elements
        const adminKeyInputDiv = document.getElementById('admin-key-input');
        const adminSecretKeyEl = document.getElementById('admin-secret-key');
        const keyMessageEl = document.getElementById('key-message');
        
        // FIX: Export this function to the global window scope so the onclick handler can see it.
        // This is necessary because the script uses "type=module".
        window.directHandleUnlock = directHandleUnlock;


        // --- CORE FUNCTIONS ---
        
        // Function to handle the unlock process (called directly from HTML)
        function directHandleUnlock() {
            // Read the value directly
            const key = adminSecretKeyEl.value.trim(); 
            
            if (key === ADMIN_SECRET) {
                console.log("Unlock successful!");
                keyMessageEl.textContent = '‚úÖ Dashboard Unlocked!';
                keyMessageEl.className = 'text-sm mt-3 font-semibold text-green-600';
                
                // Show the dashboard and start listening
                setDashboardVisibility(true);

            } else {
                console.log(Unlock failed. Entered key: ${key});
                keyMessageEl.textContent = '‚ùå Incorrect secret key. Try again.';
                keyMessageEl.className = 'text-sm mt-3 font-semibold text-red-500';
                adminSecretKeyEl.value = '';
                adminSecretKeyEl.focus();
            }
        }
        
        // Function to toggle dashboard visibility with a slight delay for transition
        function setDashboardVisibility(isVisible) {
            if (isVisible) {
                // Use a short timeout to ensure the DOM updates before class removal
                setTimeout(() => {
                    adminKeyInputDiv.classList.add('hidden');
                    adminDashboardContent.classList.remove('hidden');
                    setupRealtimeListener();
                }, 100); 

            } else {
                adminDashboardContent.classList.add('hidden');
            }
        }


        // 1. Firebase Initialization and Authentication
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                authStatusEl.textContent = 'Authenticating...';

                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); 
                        
                        if (user) {
                            userId = user.uid;
                        } else {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                    userId = auth.currentUser.uid;
                                } else {
                                    const anonUser = await signInAnonymously(auth);
                                    userId = anonUser.user.uid;
                                }
                            } catch (error) {
                                console.error("Authentication failed:", error);
                                // Fallback for userId if auth fails
                                userId = 'anonymous-' + crypto.randomUUID();
                            }
                        }
                        
                        authStatusEl.textContent = System Ready. Admin User ID: ${userId.substring(0, 8)}...${userId.substring(userId.length - 8)};
                        adminIdDisplay.textContent = userId;
                        resolve();
                    });
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                authStatusEl.textContent = 'FATAL ERROR: Check console for Firebase setup issue.';
            }
            
            // Initial state: Hidden dashboard, ready for unlock attempt
            setDashboardVisibility(false); 
            
            // Allow 'Enter' key to trigger the function on the input field
            adminSecretKeyEl.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') directHandleUnlock();
            });
        }
        

        // 2. Setup Real-time Firestore Listener for Orders
        function setupRealtimeListener() {
            if (!db) return;

            loadingIndicator.classList.remove('hidden'); 

            const ordersRef = collection(db, artifacts/${appId}/public/data/orders);
            const q = query(ordersRef); 

            onSnapshot(q, (querySnapshot) => {
                loadingIndicator.classList.add('hidden');
                
                let fetchedOrders = [];
                querySnapshot.forEach((doc) => {
                    fetchedOrders.push({ id: doc.id, ...doc.data() });
                });

                allOrders = fetchedOrders;
                // Sort orders in JavaScript: Newest orders first (by createdAt)
                allOrders.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                renderFilteredOrders(); 
            }, (error) => {
                console.error("Firestore error on orders snapshot:", error);
                loadingIndicator.classList.add('hidden');
                ordersListEl.innerHTML = <p class="text-red-500 text-center">Error fetching orders: ${error.message}</p>;
            });
            
            // Attach filter change listener (only needed once)
            statusFilterEl.addEventListener('change', (e) => {
                currentStatusFilter = e.target.value;
                renderFilteredOrders(); 
            });
        }

        // 3. Filter orders and call the renderer
        function renderFilteredOrders() {
            let ordersToRender = allOrders;

            if (currentStatusFilter !== 'All') {
                ordersToRender = allOrders.filter(order => order.status === currentStatusFilter);
            }
            
            renderOrders(ordersToRender); 
        }

        // 4. Render the Order Dashboard
        function renderOrders(orders) {
            ordersListEl.innerHTML = '';
            if (orders.length === 0) {
                ordersListEl.innerHTML = <p class="text-center text-gray-400 p-4 italic">No orders found matching the filter criteria.</p>;
                return;
            }

            orders.forEach(order => {
                const statusColor = getStatusColor(order.status);
                const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleString() : 'N/A';
                
                const orderDiv = document.createElement('div');
                orderDiv.className = 'p-4 bg-purple-50 rounded-xl border border-purple-200';
                orderDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-gray-800">Order ID: ${order.id.substring(0, 8)}</h3>
                        <span class="status-badge ${statusColor.bg} ${statusColor.text}">
                            ${order.status.toUpperCase()}
                        </span>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-1"><strong>üí∞ Amount Paid:</strong> ‚Çπ${order.amountPaid}</p>
                    <p class="text-sm text-gray-600 mb-1"><strong>üë§ Customer:</strong> ${order.name}</p>
                    <p class="text-sm text-gray-600 mb-1"><strong>üìß Email:</strong> ${order.email}</p>
                    <p class="text-sm text-gray-600 mb-1"><strong>üìû Mobile:</strong> ${order.mobile} ${order.altPhone ? (Alt: ${order.altPhone}) : ''}</p>
                    <p class="text-sm text-gray-600 mb-3"><strong>üìç Address:</strong> ${order.address}</p>
                    <p class="text-xs text-gray-400 mb-3">Placed: ${date}</p>

                    <!-- Status Update Buttons -->
                    <div class="flex flex-wrap gap-2">
                        <button data-id="${order.id}" data-status="Processing" 
                                class="status-update-btn text-xs px-3 py-1 bg-yellow-400 text-yellow-900 rounded-full hover:bg-yellow-500 transition-colors duration-150">
                            Set Processing
                        </button>
                        <button data-id="${order.id}" data-status="Delivered" 
                                class="status-update-btn text-xs px-3 py-1 bg-green-400 text-green-900 rounded-full hover:bg-green-500 transition-colors duration-150">
                            Set Delivered
                        </button>
                    </div>
                `;
                ordersListEl.appendChild(orderDiv);
            });

            // Attach listeners for status updates (must be done after rendering)
            document.querySelectorAll('.status-update-btn').forEach(btn => {
                btn.addEventListener('click', handleStatusUpdate);
            });
        }

        // Helper to get Tailwind classes for status badges
        function getStatusColor(status) {
            switch(status) {
                case 'New':
                    return { bg: 'bg-red-200', text: 'text-red-800' };
                case 'Processing':
                    return { bg: 'bg-yellow-200', text: 'text-yellow-800' };
                case 'Delivered':
                    return { bg: 'bg-green-200', text: 'text-green-800' };
                default:
                    return { bg: 'bg-gray-200', text: 'text-gray-800' };
            }
        }

        // 5. Handle Status Update 
        async function handleStatusUpdate(event) {
            const orderId = event.currentTarget.getAttribute('data-id');
            const newStatus = event.currentTarget.getAttribute('data-status');

            if (!db || !orderId) return;

            event.currentTarget.classList.add('opacity-50');
            event.currentTarget.disabled = true;

            try {
                const orderDocRef = doc(db, artifacts/${appId}/public/data/orders, orderId);
                await updateDoc(orderDocRef, {
                    status: newStatus,
                    updatedAt: serverTimestamp()
                });
            } catch (error) {
                console.error(Error updating status for ${orderId}:, error);
                event.currentTarget.classList.remove('opacity-50');
                event.currentTarget.disabled = false;
            }
        }

        window.onload = initializeFirebase;

    </script>
</body>
</html>
